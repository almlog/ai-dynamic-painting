# AI動的絵画システム 実装計画書

**プロジェクト名**: 準動的AI絵画システム (ai-dynamic-painting)  
**文書種別**: 実装計画書  
**作成日**: 2025年9月9日  
**バージョン**: 1.0

## 📋 目次
1. [プロジェクト実行方針](#プロジェクト実行方針)
2. [フェーズ別実装計画](#フェーズ別実装計画)
3. [開発環境セットアップ](#開発環境セットアップ)
4. [実装順序・依存関係](#実装順序依存関係)
5. [テスト・検証計画](#テスト検証計画)
6. [リスク管理・マイルストーン](#リスク管理マイルストーン)
7. [成果物・デリバリー](#成果物デリバリー)

---

## 🎯 プロジェクト実行方針

### AIエージェント主導開発の特徴
- **継続的改善**: 完璧な初期実装よりも、動作するものから段階的拡張
- **実験的アプローチ**: 失敗を恐れず、迅速な試行錯誤と改善
- **ドキュメント駆動**: 明確な仕様書に基づく実装で品質確保
- **モジュール設計**: 独立性の高いコンポーネントで変更リスク最小化

### 完成定義の確認
**達成目標**: 自動プロンプト生成 → VEO API → 動画生成 → ディスプレイ表示の完全自動化

### 品質方針
- **動作する最小製品**: 各フェーズで実際に使える状態を維持
- **段階的機能拡張**: 基盤を崩さず新機能を追加
- **障害許容設計**: 一部機能停止でもシステム全体は継続動作
- **ユーザビリティ優先**: 技術的完璧性より日常使用の便利さ

---

## 🚀 フェーズ別実装計画

### Phase 1: 基盤システム構築 (MVP)
**期間**: 開発開始〜基盤完成  
**目標**: 手動動画管理・表示システムの完成

#### 主要機能
- **基本表示システム**: Pygame/OpenCVによる動画再生
- **Web管理画面**: FastAPIベースの設定・管理UI
- **M5STACK基本操作**: センサー読み取り・状態表示・物理ボタン制御
- **データベース基盤**: SQLiteによる動画メタデータ管理
- **手動動画管理**: アップロード・削除・メタデータ編集

#### 技術実装内容
```
Week 1-2: 開発環境構築・基本フレームワーク
├── Raspberry Pi環境セットアップ
├── Python仮想環境・依存関係インストール
├── M5STACK開発環境構築
└── 基本プロジェクト構造作成

Week 3-4: 表示制御システム
├── DisplayController実装
├── 動画再生機能（Pygame/OpenCV）
├── フルスクリーン表示・基本操作
└── 静的画像フォールバック

Week 5-6: データベース・API基盤
├── SQLiteデータベース設計・実装
├── FastAPI基本サーバー構築
├── REST API エンドポイント実装
└── Web UI基本画面

Week 7-8: M5STACK統合
├── センサー読み取り実装
├── WiFi通信・HTTP API連携
├── LCD表示・ボタン操作
└── Raspberry Pi↔M5STACK通信確立

Week 9-10: 統合・テスト
├── コンポーネント統合
├── 基本機能テスト
├── 手動動画管理機能
└── Phase 1完成・次フェーズ準備
```

#### Phase 1 完成基準
- [ ] 手動でアップロードした動画がディスプレイに表示される
- [ ] Web UIで動画管理（アップロード・削除・メタデータ編集）ができる
- [ ] M5STACKで基本操作（次の動画・お気に入り・設定）ができる
- [ ] システム状態がM5STACKとWeb UIで確認できる
- [ ] 24時間連続稼働で安定動作する

### Phase 2: AI統合・自動化 (Auto Generation)
**期間**: Phase 1完成〜自動生成機能完成  
**目標**: VEO API統合・自動プロンプト生成・スケジュール生成

#### 主要機能
- **VEO API統合**: Google AI Pro経由での動画生成
- **プロンプト生成エンジン**: コンテキスト（時間・天気・季節）ベースの自動生成
- **生成スケジューラー**: 時間帯・使用パターンに基づく自動生成計画
- **コンテンツ選択AI**: 現在状況に最適な動画の自動選択
- **クォータ管理**: API使用量制限・コスト管理

#### 技術実装内容
```
Week 1-2: VEO API統合
├── Google AI Pro API設定・認証
├── VEOClient実装・テスト
├── 動画生成フロー構築
└── エラーハンドリング・リトライ機能

Week 3-4: プロンプト生成システム
├── ContextAnalyzer実装
├── PromptGenerator実装
├── 天気API統合
└── プロンプトテンプレート最適化

Week 5-6: 自動化システム
├── VideoGenerationScheduler実装
├── バックグラウンド生成処理
├── QuotaManager・コスト管理
└── 生成キュー・優先度管理

Week 7-8: 知的選択システム
├── VideoSelector高度化
├── コンテキストマッチング
├── フォールバック機能強化
└── M5STACK自動更新対応

Week 9-10: 統合・最適化
├── 全機能統合・テスト
├── パフォーマンス最適化
├── 安定性検証
└── Phase 2完成
```

#### Phase 2 完成基準
- [ ] 時間帯・天気情報に基づいて自動でプロンプトが生成される
- [ ] VEO APIで動画が正常に生成・保存される
- [ ] 毎日数回、適切なタイミングで新しい動画が自動生成される
- [ ] 現在の環境に最適な動画が自動選択・表示される
- [ ] API使用量・コストが適切に管理される

### Phase 3: 高度機能・運用最適化 (Advanced Features)
**期間**: Phase 2完成〜フル機能完成  
**目標**: 学習機能・運用自動化・拡張機能

#### 主要機能
- **個人化学習**: 視聴パターン・好み学習・個別最適化
- **高度な生成制御**: スタイル指定・品質調整・バリエーション管理
- **運用自動化**: 監視・バックアップ・障害対応・アップデート
- **拡張機能**: 音声認識・スマートホーム連携・外部API統合
- **パフォーマンス最適化**: 負荷分散・キャッシュ戦略・リソース効率化

#### 技術実装内容
```
Week 1-3: 学習・個人化システム
├── UserPreferenceEngine実装
├── 視聴パターン分析
├── 好み学習・反映機能
└── 個別プロンプト調整

Week 4-6: 高度生成制御
├── スタイル・品質制御
├── プロンプト詳細化
├── 生成バリエーション管理
└── A/Bテスト機能

Week 7-9: 運用自動化
├── SystemMonitor実装
├── BackupManager・自動バックアップ
├── UpdateManager・自動アップデート
└── アラート・通知システム

Week 10-12: 拡張機能・最適化
├── 音声認識（オプション）
├── スマートホーム連携
├── パフォーマンス最適化
└── 最終統合・完成
```

#### Phase 3 完成基準
- [ ] ユーザーの好みを学習して動画選択・生成が最適化される
- [ ] システムが自動で監視・メンテナンス・アップデートされる
- [ ] 拡張機能（音声認識・スマートホーム連携）が動作する
- [ ] 長期運用（3ヶ月以上）で安定稼働する
- [ ] 企画書の全要件が満たされる

---

## 🛠️ 開発環境セットアップ

### 必要機材・前提条件
- **Raspberry Pi 4/5** (8GB RAM推奨)
- **M5STACK Core/Core2** + センサーモジュール
- **PCモニター** (24-32インチ、HDMI)
- **開発用PC** (SSH・リモート開発用)
- **安定したWiFiネットワーク**

### Raspberry Pi セットアップ
```bash
# 1. Raspberry Pi OS インストール・初期設定
sudo apt update && sudo apt upgrade -y
sudo apt install -y python3-pip python3-venv git sqlite3
sudo apt install -y libopencv-dev python3-opencv libpygame-dev

# 2. プロジェクトディレクトリ作成
mkdir -p /home/pi/ai_painting_system
cd /home/pi/ai_painting_system

# 3. 仮想環境作成・依存関係インストール
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip

# 4. 必要パッケージインストール
pip install fastapi uvicorn pygame opencv-python
pip install sqlalchemy alembic python-dotenv
pip install requests aiohttp google-generativeai
pip install psutil schedule

# 5. プロジェクト構造作成
mkdir -p {config,core,api,web,database,utils,logs}
mkdir -p {video_cache,static,templates}

# 6. 設定ファイル作成
touch .env config/settings.py
```

### M5STACK セットアップ
```cpp
// Arduino IDE ライブラリインストール
// - M5Stack ライブラリ
// - WiFi ライブラリ  
// - ArduinoJson ライブラリ
// - HTTPClient ライブラリ

// プロジェクト作成
// File > New > ai_painting_m5stack.ino

// 基本設定
#include <M5Stack.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// WiFi設定
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
const char* pi_ip = "192.168.1.100";  // Raspberry PiのIP
```

### 開発用PC セットアップ
```bash
# SSH接続設定
ssh-keygen -t rsa -b 4096
ssh-copy-id pi@192.168.1.100

# VSCode Remote SSH拡張機能インストール
# Git設定
git config --global user.name "Your Name"
git config --global user.email "your@email.com"

# プロジェクトクローン・同期設定
```

### API キー・認証設定
```bash
# .env ファイル設定
echo "GEMINI_API_KEY=your_gemini_api_key_here" >> .env
echo "WEATHER_API_KEY=your_weather_api_key_here" >> .env
echo "LOG_LEVEL=INFO" >> .env
echo "DATABASE_URL=sqlite:///./painting_system.db" >> .env

# パーミッション設定
chmod 600 .env
```

---

## 📊 実装順序・依存関係

### 実装依存関係図
```
Phase 1 基盤システム
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Database    │────│ Video       │────│ Display     │
│ Setup       │    │ Manager     │    │ Controller  │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Config      │────│ FastAPI     │────│ Web UI      │
│ Manager     │    │ Server      │    │ Basic       │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │
       ▼                   ▼
┌─────────────┐    ┌─────────────┐
│ M5STACK     │────│ System      │
│ Integration │    │ Integration │
└─────────────┘    └─────────────┘

Phase 2 AI統合
       │
       ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ VEO API     │────│ Prompt      │────│ Scheduler   │
│ Client      │    │ Generator   │    │ System      │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Context     │────│ Content     │────│ Quota       │
│ Analyzer    │    │ Selector    │    │ Manager     │
└─────────────┘    └─────────────┘    └─────────────┘

Phase 3 高度機能
       │
       ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Learning    │────│ Monitor     │────│ Backup      │
│ Engine      │    │ System      │    │ Manager     │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 優先実装順序
1. **DatabaseManager** → **ConfigManager** (基盤)
2. **DisplayController** (表示機能)
3. **FastAPI Server** → **Web UI Basic** (管理機能)
4. **M5STACK Integration** (制御機能)
5. **VEO API Client** (生成機能)
6. **Prompt Generator** → **Scheduler** (自動化)
7. **Context Analyzer** → **Content Selector** (知的機能)
8. **Learning Engine** → **Monitor System** (高度機能)

### 各フェーズでの検証項目
```python
# Phase 1 検証チェックリスト
PHASE_1_VERIFICATION = [
    "手動動画アップロード・表示確認",
    "Web UI基本操作確認",
    "M5STACKボタン操作確認",
    "24時間連続稼働テスト",
    "基本エラーハンドリング確認"
]

# Phase 2 検証チェックリスト  
PHASE_2_VERIFICATION = [
    "VEO API動画生成確認",
    "自動プロンプト生成確認",
    "スケジュール生成動作確認",
    "コンテキスト選択精度確認",
    "API使用量・コスト確認"
]

# Phase 3 検証チェックリスト
PHASE_3_VERIFICATION = [
    "学習機能動作確認",
    "自動運用機能確認", 
    "拡張機能動作確認",
    "長期運用安定性確認",
    "全要件達成確認"
]
```

---

## 🧪 テスト・検証計画

### テスト戦略
- **ユニットテスト**: 個別モジュール・関数の動作確認
- **統合テスト**: コンポーネント間連携の確認
- **システムテスト**: エンドツーエンドの動作確認
- **運用テスト**: 長期稼働・障害対応の確認

### テスト環境構成
```python
# テスト用設定
TEST_CONFIG = {
    "database": "sqlite:///./test_painting_system.db",
    "video_cache": "./test_video_cache/",
    "api_mock": True,  # VEO API モック使用
    "log_level": "DEBUG",
    "test_data_path": "./test_data/"
}

# テストデータ準備
TEST_VIDEOS = [
    "test_morning.mp4",
    "test_evening.mp4", 
    "test_night.mp4",
    "test_rainy.mp4"
]

# モックAPI設定
MOCK_VEO_RESPONSES = {
    "success": {"video_url": "mock_video.mp4", "cost": 0.0},
    "quota_exceeded": {"error": "Quota exceeded"},
    "network_error": {"error": "Network timeout"}
}
```

### 自動テストスイート
```python
# tests/test_core.py
import pytest
from core.video_manager import VideoManager
from core.display_controller import DisplayController

class TestVideoManager:
    def test_video_selection(self):
        # コンテキストに基づく動画選択テスト
        pass
    
    def test_video_metadata(self):
        # メタデータ管理テスト
        pass

class TestDisplayController:
    def test_video_loading(self):
        # 動画読み込みテスト
        pass
    
    def test_fallback_display(self):
        # フォールバック表示テスト
        pass

# 実行コマンド
# python -m pytest tests/ -v --cov=core
```

### 性能テスト計画
```python
# パフォーマンステスト項目
PERFORMANCE_TESTS = {
    "video_switch_time": {"target": "< 3秒", "method": "タイマー測定"},
    "api_response_time": {"target": "< 5秒", "method": "HTTP応答時間"},
    "memory_usage": {"target": "< 80%", "method": "psutil監視"},
    "cpu_usage": {"target": "< 30%", "method": "連続監視"},
    "disk_io": {"target": "正常範囲", "method": "IOPSカウント"}
}

# 負荷テスト
LOAD_TESTS = {
    "concurrent_api_calls": "同時API呼び出し耐性",
    "long_term_operation": "7日間連続稼働",
    "memory_leak_check": "メモリリーク検出",
    "storage_growth": "ストレージ使用量増加率"
}
```

### ユーザビリティテスト
```python
# UI/UX検証項目
USABILITY_TESTS = [
    "Web UI直感操作性",
    "M5STACKボタン操作簡便性", 
    "エラーメッセージ分かりやすさ",
    "設定変更の反映確認",
    "スマートフォンからのアクセス"
]

# アクセシビリティ確認
ACCESSIBILITY_TESTS = [
    "画面サイズ対応",
    "ネットワーク不安定時の挙動",
    "バッテリー残量低下時の対応",
    "高負荷時のレスポンス"
]
```

---

## ⚠️ リスク管理・マイルストーン

### リスク分析・対策マトリックス
| リスク項目 | 発生確率 | 影響度 | 対策 | 責任 |
|---|---|---|---|---|
| VEO API仕様変更 | 中 | 高 | アダプター層実装・複数API対応 | 開発 |
| Raspberry Pi性能不足 | 低 | 中 | 軽量化・クラウド処理分散 | 設計 |
| M5STACK通信不安定 | 中 | 低 | 再接続機能・有線接続代替 | 実装 |
| 開発期間延長 | 高 | 中 | 段階的リリース・優先機能明確化 | 管理 |
| API コスト超過 | 中 | 中 | 使用量監視・上限設定 | 運用 |

### 対策実装
```python
# リスク対応コード例
class RiskMitigation:
    def __init__(self):
        self.fallback_strategies = {
            "api_failure": self.use_cached_content,
            "network_failure": self.offline_mode,
            "storage_full": self.cleanup_old_files,
            "memory_overflow": self.restart_services
        }
    
    async def handle_risk_event(self, risk_type: str, context: dict):
        """リスク発生時の自動対応"""
        if risk_type in self.fallback_strategies:
            await self.fallback_strategies[risk_type](context)
            await self.log_risk_event(risk_type, context)
            await self.notify_admin_if_critical(risk_type)
```

### マイルストーン設定
#### Phase 1 マイルストーン
- **M1.1**: 開発環境構築完了
- **M1.2**: 基本表示機能動作確認
- **M1.3**: Web UI基本機能完成  
- **M1.4**: M5STACK統合完了
- **M1.5**: Phase 1統合テスト完了

#### Phase 2 マイルストーン
- **M2.1**: VEO API統合成功
- **M2.2**: 自動プロンプト生成動作確認
- **M2.3**: スケジュール生成機能完成
- **M2.4**: 自動選択機能動作確認
- **M2.5**: Phase 2統合テスト完了

#### Phase 3 マイルストーン
- **M3.1**: 学習機能動作確認
- **M3.2**: 運用自動化機能完成
- **M3.3**: 拡張機能動作確認
- **M3.4**: 長期運用テスト完了
- **M3.5**: 全機能統合・プロジェクト完成

### 進捗管理方法
```python
# 進捗追跡システム
class ProgressTracker:
    def __init__(self):
        self.milestones = self.load_milestones()
        self.current_phase = 1
        
    def update_milestone(self, milestone_id: str, status: str):
        """マイルストーン状況更新"""
        self.milestones[milestone_id] = {
            "status": status,  # planned, in_progress, completed, blocked
            "updated_at": datetime.now(),
            "completion_rate": self.calculate_completion_rate()
        }
        
    def generate_progress_report(self) -> dict:
        """進捗レポート生成"""
        return {
            "overall_progress": self.calculate_overall_progress(),
            "current_phase": self.current_phase,
            "next_milestones": self.get_next_milestones(),
            "blocked_items": self.get_blocked_items(),
            "estimated_completion": self.estimate_completion_date()
        }
```

---

## 📦 成果物・デリバリー

### Phase別成果物
#### Phase 1 成果物
```
ai_painting_system/
├── core/
│   ├── display_controller.py      # 表示制御システム
│   ├── video_manager.py           # 動画管理システム
│   └── config_manager.py          # 設定管理システム
├── database/
│   ├── models.py                  # データモデル定義
│   ├── database.py                # DB操作クラス
│   └── init_db.sql                # 初期DB設定
├── web/
│   ├── app.py                     # FastAPIアプリ
│   ├── routes/                    # APIルート定義
│   └── static/                    # 静的ファイル
├── m5stack/
│   └── ai_painting_m5stack.ino    # M5STACKプログラム
├── docs/
│   ├── setup_guide.md             # セットアップガイド
│   ├── user_manual.md             # ユーザーマニュアル
│   └── api_reference.md           # API仕様書
└── tests/
    ├── test_core.py               # コアモジュールテスト
    ├── test_web.py                # Web APIテスト
    └── test_integration.py        # 統合テスト
```

#### Phase 2 成果物
```
追加ファイル:
├── api/
│   ├── veo_client.py              # VEO API統合
│   ├── weather_client.py          # 天気API統合
│   └── prompt_generator.py        # プロンプト生成
├── core/
│   ├── context_analyzer.py        # コンテキスト分析
│   ├── scheduler.py               # 生成スケジューラー
│   └── quota_manager.py           # クォータ管理
├── utils/
│   ├── ai_helpers.py              # AI関連ユーティリティ
│   └── async_workers.py           # 非同期ワーカー
└── configs/
    ├── prompt_templates.json      # プロンプトテンプレート
    └── generation_rules.json      # 生成ルール設定
```

#### Phase 3 成果物
```
追加ファイル:
├── advanced/
│   ├── learning_engine.py         # 学習エンジン
│   ├── preference_analyzer.py     # 好み分析
│   └── optimization.py            # 最適化システム
├── monitoring/
│   ├── system_monitor.py          # システム監視
│   ├── backup_manager.py          # バックアップ管理
│   └── alert_system.py            # アラートシステム
├── extensions/
│   ├── voice_control.py           # 音声制御（オプション）
│   └── smart_home_integration.py  # スマートホーム連携
└── deployment/
    ├── install.sh                 # 自動インストールスクリプト
    ├── systemd/                   # サービス定義
    └── backup_scripts/            # バックアップスクリプト
```

### ドキュメント成果物
1. **技術ドキュメント**
   - システムアーキテクチャ説明書
   - API リファレンス
   - データベーススキーマ説明
   - 設定ファイルリファレンス

2. **運用ドキュメント**  
   - セットアップ・インストールガイド
   - 日常運用マニュアル
   - トラブルシューティングガイド
   - メンテナンス手順書

3. **ユーザードキュメント**
   - ユーザーマニュアル
   - Web UI操作ガイド
   - M5STACK操作ガイド
   - FAQ・よくある質問

### コード品質・基準
```python
# コーディング規約
CODING_STANDARDS = {
    "style": "PEP 8準拠",
    "docstring": "Google Style",
    "type_hints": "必須",
    "test_coverage": "80%以上",
    "complexity": "Cyclomatic complexity < 10"
}

# 品質チェック
QUALITY_CHECKS = [
    "flake8 .",                    # スタイルチェック
    "mypy .",                      # 型チェック
    "pytest --cov=core",          # テストカバレッジ
    "bandit -r .",                # セキュリティチェック
    "pylint core/"                # 品質チェック
]
```

### デプロイメント・パッケージング
```bash
# 自動インストールスクリプト
# install.sh
#!/bin/bash
set -e

echo "AI Dynamic Painting System Installation"
echo "======================================="

# 環境チェック
check_environment() {
    if [[ "$EUID" -eq 0 ]]; then
        echo "Error: Do not run as root"
        exit 1
    fi
    
    if ! command -v python3 &> /dev/null; then
        echo "Error: Python 3 not found"
        exit 1
    fi
}

# 依存関係インストール
install_dependencies() {
    echo "Installing system dependencies..."
    sudo apt update
    sudo apt install -y python3-pip python3-venv sqlite3
    
    echo "Creating virtual environment..."
    python3 -m venv venv
    source venv/bin/activate
    
    echo "Installing Python packages..."
    pip install -r requirements.txt
}

# 設定・初期化
initialize_system() {
    echo "Initializing database..."
    python3 -m database.init_db
    
    echo "Creating directories..."
    mkdir -p {logs,video_cache,backups}
    
    echo "Setting up systemd service..."
    sudo cp deployment/systemd/ai-painting.service /etc/systemd/system/
    sudo systemctl daemon-reload
    sudo systemctl enable ai-painting
}

# メイン実行
main() {
    check_environment
    install_dependencies  
    initialize_system
    
    echo "Installation completed!"
    echo "Run 'sudo systemctl start ai-painting' to start the system"
}

main
```

---

## 🎯 実装開始・次ステップ

### 実装開始準備
1. **ハードウェア準備**: Raspberry Pi・M5STACK・モニター設定
2. **開発環境構築**: セットアップスクリプト実行
3. **API キー取得**: Google AI Pro・天気APIキー設定
4. **プロジェクト初期化**: Git リポジトリ・基本構造作成

### AIエージェント開発開始コマンド
```bash
# プロジェクト開始
git clone <repository-url> ai_painting_system
cd ai_painting_system

# 環境構築
./scripts/setup_environment.sh

# Phase 1開発開始
python3 -m scripts.init_phase1

# 開発サーバー起動
source venv/bin/activate
python3 main.py --mode development
```

### 継続的改善プロセス
1. **日次**: 機能実装・テスト・コミット
2. **週次**: 統合テスト・進捗レビュー・調整
3. **マイルストーン**: 機能完成・検証・次フェーズ準備
4. **フェーズ完成**: 包括的テスト・ドキュメント更新・リリース

---
