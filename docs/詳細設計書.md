# AI動的絵画システム 詳細設計書

**プロジェクト名**: 準動的AI絵画システム (ai-dynamic-painting)  
**文書種別**: 詳細設計書  
**作成日**: 2025年9月9日  
**バージョン**: 1.0

## 📋 目次
1. [システムアーキテクチャ](#システムアーキテクチャ)
2. [ハードウェア設計](#ハードウェア設計)
3. [ソフトウェア設計](#ソフトウェア設計)
4. [データベース設計](#データベース設計)
5. [API設計](#api設計)
6. [UI/UX設計](#uiux設計)
7. [セキュリティ設計](#セキュリティ設計)
8. [運用・保守設計](#運用保守設計)

---

## 🏗️ システムアーキテクチャ

### 全体構成図
```
┌─────────────────┐    WiFi     ┌─────────────────────────────────┐
│   M5STACK       │◄───────────►│      Raspberry Pi               │
│  ・センサー      │             │  ┌─────────────────────────────┐ │
│  ・制御UI       │             │  │     Main Application        │ │
│  ・状態表示     │             │  │  ┌─────────┬─────────────┐ │ │
└─────────────────┘             │  │  │FastAPI  │Display      │ │ │
                                │  │  │Server   │Controller   │ │ │
┌─────────────────┐             │  │  └─────────┴─────────────┘ │ │
│  User Devices   │    WiFi     │  │  ┌─────────┬─────────────┐ │ │
│  ・スマホ       │◄───────────►│  │  │Video    │AI Prompt    │ │ │
│  ・PC           │             │  │  │Manager  │Generator    │ │ │
│  ・タブレット   │             │  │  └─────────┴─────────────┘ │ │
└─────────────────┘             │  │  ┌─────────┬─────────────┐ │ │
                                │  │  │Database │Config       │ │ │
┌─────────────────┐             │  │  │Manager  │Manager      │ │ │
│   PC Monitor    │    HDMI     │  │  └─────────┴─────────────┘ │ │
│  ・24-32inch    │◄───────────►│  └─────────────────────────────┘ │
│  ・1080p+       │             └─────────────────────────────────┘
│  ・フルスクリーン│                            │
└─────────────────┘                            │ HTTPS
                                               │
                                    ┌─────────▼─────────┐
                                    │   External APIs   │
                                    │  ・Google VEO API │
                                    │  ・Weather API    │
                                    │  ・その他クラウド  │
                                    └───────────────────┘
```

### コンポーネント通信仕様
| 通信路 | プロトコル | 形式 | 頻度 |
|---|---|---|---|
| M5STACK ⟷ Pi | HTTP/WiFi | JSON | 30秒間隔 |
| User ⟷ Pi | HTTP/WiFi | HTML/JSON | リクエスト時 |
| Pi ⟷ VEO API | HTTPS | JSON | 数時間間隔 |
| Pi ⟷ Monitor | HDMI | 映像信号 | リアルタイム |

### データフロー詳細
```
センサーデータ収集 → コンテキスト分析 → 動画選択/生成判定 → API呼び出し → 動画保存 → 表示更新
     ↑                    ↓                     ↓               ↓           ↓         ↓
M5STACK ←← 状態通知 ←← 判定結果 ←← 生成キュー ←← VEO API ←← 保存完了 ←← 表示中
```

---

## 🔧 ハードウェア設計

### 必要機器仕様
| コンポーネント | モデル例 | 仕様 | 役割 |
|---|---|---|---|
| SBC | Raspberry Pi 4B/5 | 8GB RAM, WiFi, HDMI | メイン処理 |
| 制御デバイス | M5STACK Core/Core2 | WiFi, LCD, ボタン×3 | 制御・表示 |
| ディスプレイ | 汎用PCモニター | 24-32inch, 1080p+ | 動画表示 |
| センサー | 各種モジュール | 光・温度・人感 | 環境検知 |

### M5STACKセンサー構成
```cpp
// センサーピン配置
#define LIGHT_SENSOR_PIN    36  // アナログ光センサー
#define TEMP_SENSOR_PIN     21  // I2C温度センサー
#define PIR_SENSOR_PIN      2   // デジタル人感センサー
#define BUTTON_A_PIN        39  // 内蔵ボタンA
#define BUTTON_B_PIN        38  // 内蔵ボタンB  
#define BUTTON_C_PIN        37  // 内蔵ボタンC
```

### 配線・設置設計
```
M5STACK配置:
┌─────────────────┐
│    ディスプレイ    │
│                 │  ┌─────────┐
│                 │  │M5STACK  │
│     動画表示     │  │┌─────┐  │
│                 │  ││ LCD ││  │
│                 │  │└─────┘  │
└─────────────────┘  │ A B C   │
                    └─────────┘
```

### 電源・ケーブル設計
- **Raspberry Pi**: USB-C 5V/3A
- **M5STACK**: USB-C 5V/1A
- **ディスプレイ**: AC電源（機種依存）
- **HDMI**: Raspberry Pi → ディスプレイ
- **ネットワーク**: WiFi（有線LAN予備）

---

## 💻 ソフトウェア設計

### 技術スタック詳細
| レイヤー | 技術 | バージョン | 用途 |
|---|---|---|---|
| OS | Raspberry Pi OS | 64-bit | ベースOS |
| Runtime | Python | 3.11+ | メイン言語 |
| Webフレームワーク | FastAPI | 0.100+ | REST API |
| DB | SQLite | 3.40+ | データ永続化 |
| 表示制御 | Pygame | 2.5+ | 動画再生 |
| 画像処理 | OpenCV | 4.8+ | 動画処理 |
| フロントエンド | HTML/CSS/JS | - | Web UI |
| M5STACK | Arduino IDE | - | IoTデバイス |

### モジュール構成
```
ai_painting_system/
├── main.py                 # メインアプリケーション
├── config/
│   ├── settings.py         # 設定管理
│   └── constants.py        # 定数定義
├── core/
│   ├── display_controller.py    # 表示制御
│   ├── video_manager.py         # 動画管理
│   ├── prompt_generator.py      # プロンプト生成
│   └── context_analyzer.py      # コンテキスト分析
├── api/
│   ├── veo_client.py       # VEO API統合
│   ├── weather_client.py   # 天気API統合
│   └── m5stack_api.py      # M5STACK通信
├── web/
│   ├── app.py              # FastAPI アプリ
│   ├── routes/             # APIルート
│   └── static/             # 静的ファイル
├── database/
│   ├── models.py           # データモデル
│   └── database.py         # DB操作
└── utils/
    ├── logger.py           # ログ管理
    └── helpers.py          # ユーティリティ
```

### 主要クラス設計

#### DisplayController
```python
class DisplayController:
    """表示制御メインクラス"""
    
    def __init__(self):
        self.screen: pygame.Surface
        self.video_player: VideoPlayer
        self.overlay_manager: OverlayManager
        
    def load_video(self, video_path: str) -> bool:
        """動画読み込み"""
        
    def update_display(self) -> None:
        """表示更新（30fps）"""
        
    def show_overlay(self, data: dict) -> None:
        """オーバーレイ表示（時刻・天気等）"""
```

#### VideoManager
```python
class VideoManager:
    """動画管理クラス"""
    
    def __init__(self, db: DatabaseManager):
        self.db = db
        self.cache_manager = CacheManager()
        
    def select_best_video(self, context: dict) -> str:
        """最適動画選択"""
        
    def add_video(self, video_path: str, metadata: dict) -> int:
        """動画登録"""
        
    def cleanup_old_videos(self) -> None:
        """古い動画削除"""
```

#### VEOClient
```python
class VEOClient:
    """VEO API クライアント"""
    
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.quota_manager = QuotaManager()
        
    async def generate_video(self, prompt: str) -> dict:
        """動画生成"""
        
    def check_quota(self) -> int:
        """残りクォータ確認"""
```

### 設定管理設計
```python
# settings.py
class Settings:
    # API設定
    VEO_API_KEY: str = ""
    WEATHER_API_KEY: str = ""
    
    # 表示設定
    DISPLAY_WIDTH: int = 1920
    DISPLAY_HEIGHT: int = 1080
    FULLSCREEN: bool = True
    
    # 生成設定
    DAILY_GENERATION_LIMIT: int = 3
    VIDEO_CACHE_SIZE_GB: int = 10
    
    # M5STACK設定
    M5STACK_IP: str = "192.168.1.100"
    SENSOR_UPDATE_INTERVAL: int = 30
```

---

## 🗄️ データベース設計

### ERダイアグラム
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     videos      │    │   video_tags    │    │      tags       │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ id (PK)         │    │ video_id (FK)   │    │ id (PK)         │
│ filepath        │    │ tag_id (FK)     │    │ name            │
│ prompt          │    └─────────────────┘    │ category        │
│ time_period     │                           └─────────────────┘
│ weather         │
│ season          │    ┌─────────────────┐
│ generated_at    │    │   user_prefs    │
│ view_count      │    ├─────────────────┤
│ user_rating     │    │ id (PK)         │
│ api_cost        │    │ key             │
│ file_size       │    │ value           │
│ duration        │    │ updated_at      │
└─────────────────┘    └─────────────────┘

┌─────────────────┐    ┌─────────────────┐
│ generation_log  │    │  system_status  │
├─────────────────┤    ├─────────────────┤
│ id (PK)         │    │ id (PK)         │
│ date            │    │ component       │
│ videos_generated│    │ status          │
│ total_cost      │    │ last_check      │
│ api_calls       │    │ error_count     │
│ success_rate    │    │ data            │
└─────────────────┘    └─────────────────┘
```

### テーブル詳細仕様

#### videos テーブル
```sql
CREATE TABLE videos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filepath TEXT UNIQUE NOT NULL,
    prompt TEXT NOT NULL,
    time_period TEXT CHECK(time_period IN ('morning', 'daytime', 'evening', 'night')),
    weather TEXT CHECK(weather IN ('sunny', 'cloudy', 'rainy', 'snowy', 'stormy')),
    season TEXT CHECK(season IN ('spring', 'summer', 'autumn', 'winter')),
    mood TEXT,
    style TEXT DEFAULT 'realistic',
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    view_count INTEGER DEFAULT 0,
    user_rating REAL DEFAULT 0.0,
    api_cost REAL DEFAULT 0.0,
    file_size INTEGER DEFAULT 0,
    duration REAL DEFAULT 8.0,
    is_manual_upload BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### user_preferences テーブル
```sql
CREATE TABLE user_preferences (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT UNIQUE NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    category TEXT DEFAULT 'general',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初期設定値
INSERT INTO user_preferences (key, value, description, category) VALUES
('display_overlay', 'true', 'オーバーレイ表示設定', 'display'),
('auto_generation', 'true', '自動生成有効化', 'generation'),
('preferred_time_morning', '06:00', '朝の開始時刻', 'schedule'),
('preferred_time_evening', '18:00', '夕方の開始時刻', 'schedule');
```

### データアクセス層設計
```python
class DatabaseManager:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.init_database()
    
    # 動画管理
    def add_video(self, video_data: dict) -> int
    def get_videos_by_context(self, context: dict) -> List[dict]
    def update_video_stats(self, video_id: int, view_count: int = None, rating: float = None)
    def delete_video(self, video_id: int) -> bool
    
    # 設定管理
    def get_preference(self, key: str) -> str
    def set_preference(self, key: str, value: str) -> bool
    def get_all_preferences(self) -> dict
    
    # ログ・統計
    def log_generation(self, date: str, cost: float, success: bool)
    def get_monthly_stats(self, year_month: str) -> dict
```

---

## 🔌 API設計

### REST API仕様

#### 基本情報
- **ベースURL**: `http://192.168.1.xxx:8080/api/v1`
- **認証**: なし（ローカルネットワーク）
- **レスポンス形式**: JSON
- **エラーハンドリング**: HTTP ステータスコード + JSON

#### エンドポイント一覧

#### システム管理
```
GET    /api/v1/status           # システム状態取得
POST   /api/v1/restart          # システム再起動
GET    /api/v1/logs             # ログ取得
```

#### 動画管理
```
GET    /api/v1/videos           # 動画一覧取得
POST   /api/v1/videos           # 動画アップロード
GET    /api/v1/videos/{id}      # 動画詳細取得
PUT    /api/v1/videos/{id}      # 動画情報更新
DELETE /api/v1/videos/{id}      # 動画削除
POST   /api/v1/videos/generate  # 動画生成リクエスト
```

#### 表示制御
```
GET    /api/v1/display/current  # 現在表示中動画
POST   /api/v1/display/switch   # 動画切り替え
PUT    /api/v1/display/settings # 表示設定更新
```

#### 設定管理
```
GET    /api/v1/config           # 全設定取得
PUT    /api/v1/config           # 設定更新
GET    /api/v1/config/{key}     # 個別設定取得
PUT    /api/v1/config/{key}     # 個別設定更新
```

#### M5STACK通信
```
POST   /api/v1/sensors          # センサーデータ受信
POST   /api/v1/commands         # コマンド受信
GET    /api/v1/m5stack/status   # M5STACK用状態送信
```

### API詳細仕様例

#### GET /api/v1/videos
```json
{
  "videos": [
    {
      "id": 1,
      "filepath": "/cache/video_001.mp4",
      "prompt": "Cherry blossoms in morning sunlight",
      "time_period": "morning",
      "weather": "sunny",
      "season": "spring",
      "generated_at": "2025-09-09T08:00:00Z",
      "view_count": 5,
      "user_rating": 4.5,
      "duration": 8.0
    }
  ],
  "total": 45,
  "page": 1,
  "per_page": 20
}
```

#### POST /api/v1/videos/generate
```json
// Request
{
  "context": {
    "time_period": "evening",
    "weather": "rainy",
    "season": "autumn"
  },
  "priority": "high",
  "custom_prompt": "Cozy fireplace scene"
}

// Response
{
  "generation_id": "gen_12345",
  "status": "queued",
  "estimated_time": 300,
  "quota_remaining": 87
}
```

### VEO API統合仕様
```python
class VEOAPIWrapper:
    async def generate_video(self, prompt: str, config: dict) -> dict:
        """
        VEO API呼び出しラッパー
        
        Args:
            prompt: 生成プロンプト
            config: 生成設定
            
        Returns:
            {
                "success": bool,
                "video_url": str,
                "generation_time": float,
                "cost": float,
                "error": str
            }
        """
```

---

## 🎨 UI/UX設計

### Web設定画面設計

#### 画面構成
```
┌─────────────────────────────────────────────────────────┐
│ AI Dynamic Painting - Control Panel                    │
├─────────────────────────────────────────────────────────┤
│ [Dashboard] [Videos] [Generation] [Settings] [Logs]    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  現在の状態                                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │システム状態  │ │動画再生中    │ │月間使用量    │        │
│  │   🟢 正常   │ │Evening Rain │ │  45/90      │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
│                                                         │
│  クイックアクション                                       │
│  [次の動画] [生成リクエスト] [再起動] [メンテナンス]       │
│                                                         │
│  最近の動画 (5件)                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 🎬 Morning_Forest.mp4    [▶] [⭐] [🗑]              │ │
│  │ 🎬 Evening_Rain.mp4      [▶] [⭐] [🗑]              │ │
│  │ 🎬 Night_Stars.mp4       [▶] [⭐] [🗑]              │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### 動画管理画面
```
動画ライブラリ
┌─────────────────────────────────────────────────────────┐
│ 📁 Filter: [All] [Generated] [Uploaded] [Favorites]    │
│ 🔍 Search: [                     ] [Search]           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │[Thumb]  │ │[Thumb]  │ │[Thumb]  │ │[Thumb]  │        │
│ │Morning  │ │Evening  │ │Night    │ │Rainy    │        │
│ │Sunny    │ │Cloudy   │ │Clear    │ │Day      │        │
│ │⭐⭐⭐⭐  │ │⭐⭐⭐   │ │⭐⭐⭐⭐⭐│ │⭐⭐     │        │
│ │Views:12 │ │Views:8  │ │Views:15 │ │Views:3  │        │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
│                                                         │
│ [+ Upload Video] [🎬 Generate New] [⚙ Batch Actions]   │
└─────────────────────────────────────────────────────────┘
```

#### 設定画面
```
システム設定
┌─────────────────────────────────────────────────────────┐
│ 表示設定                                                │
│ ☑ オーバーレイ表示 (時刻・天気)                          │
│ ☑ 自動明度調整                                          │
│ Brightness: [●────────] 70%                            │
│                                                         │
│ 生成設定                                                │
│ ☑ 自動生成有効                                          │
│ Daily Limit: [3] videos                                │
│ Quality: [●] High [○] Medium [○] Fast                  │
│                                                         │
│ スケジュール                                             │
│ Morning: [06:00] - [10:00]                             │
│ Evening: [18:00] - [22:00]                             │
│ ☑ Weekend special generation                           │
│                                                         │
│ API設定                                                 │
│ VEO API Key: [●●●●●●●●●●●●] [Test Connection]         │
│ Weather API Key: [●●●●●●●●●●●●] [Test Connection]     │
│                                                         │
│ [Save Settings] [Reset to Defaults] [Export Config]    │
└─────────────────────────────────────────────────────────┘
```

### M5STACK UI設計

#### メイン画面
```
┌─────────────────┐
│ AI Painting     │
│ 🌅 Morning/Sunny│  <- 時間帯/天気アイコン
│ 📹 Video: 3/12  │  <- 現在動画/総数
│ 💡 Light: 65%   │  <- 光センサー値
│ 🌡️ Temp: 23°C   │  <- 温度
│ WiFi: ●●●○     │  <- WiFi信号強度
│                 │
│ A:Next B:❤ C:⚙ │  <- ボタン機能
└─────────────────┘
```

#### 設定メニュー
```
┌─────────────────┐
│   Settings      │
│                 │
│ > Display       │  <- ボタンAで選択
│   Generation    │
│   Network       │
│   System        │
│                 │
│ A:Select B:Back │
└─────────────────┘
```

### レスポンシブ設計
- **スマートフォン**: 縦画面最適化、タッチ操作
- **タブレット**: 横画面、詳細表示
- **PC**: フル機能、マルチカラム

---

## 🔒 セキュリティ設計

### セキュリティ脅威分析
| 脅威 | リスクレベル | 対策 |
|---|---|---|
| 不正ネットワークアクセス | 中 | ローカルネットワーク制限 |
| API キー漏洩 | 高 | 環境変数・暗号化保存 |
| 動画ファイル改ざん | 低 | ファイル整合性チェック |
| DoS攻撃 | 低 | レート制限・監視 |

### 実装セキュリティ対策

#### ネットワークセキュリティ
```python
# FastAPI セキュリティ設定
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import ipaddress

app = FastAPI()

# CORS設定（ローカルネットワークのみ）
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://192.168.1.*", "http://localhost:*"],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# IP制限ミドルウェア
@app.middleware("http")
async def limit_local_network(request: Request, call_next):
    client_ip = request.client.host
    
    # ローカルネットワークチェック
    if not (ipaddress.ip_address(client_ip).is_private or 
            client_ip == "127.0.0.1"):
        raise HTTPException(status_code=403, detail="Access denied")
    
    response = await call_next(request)
    return response
```

#### データ保護
```python
# API キー暗号化保存
from cryptography.fernet import Fernet
import os

class SecureConfig:
    def __init__(self):
        self.key = self._get_or_create_key()
        self.cipher = Fernet(self.key)
    
    def _get_or_create_key(self) -> bytes:
        key_file = "/home/pi/.painting_key"
        if os.path.exists(key_file):
            with open(key_file, 'rb') as f:
                return f.read()
        else:
            key = Fernet.generate_key()
            with open(key_file, 'wb') as f:
                f.write(key)
            os.chmod(key_file, 0o600)  # 所有者のみ読み取り可能
            return key
    
    def store_api_key(self, service: str, api_key: str):
        encrypted = self.cipher.encrypt(api_key.encode())
        # データベースに暗号化されたキーを保存
        
    def get_api_key(self, service: str) -> str:
        # データベースから暗号化されたキーを取得・復号
        pass
```

#### ファイル整合性
```python
import hashlib

class FileIntegrityManager:
    def calculate_checksum(self, filepath: str) -> str:
        sha256_hash = hashlib.sha256()
        with open(filepath, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                sha256_hash.update(chunk)
        return sha256_hash.hexdigest()
    
    def verify_video_integrity(self, video_id: int) -> bool:
        video_data = self.db.get_video(video_id)
        current_checksum = self.calculate_checksum(video_data['filepath'])
        return current_checksum == video_data.get('checksum', '')
```

### 運用セキュリティ
- **定期バックアップ**: 重要データの自動バックアップ
- **ログ監視**: 異常アクセスの検出・アラート
- **アップデート管理**: セキュリティパッチの定期適用
- **アクセス制御**: SSH鍵認証、sudo制限

---

## 🔧 運用・保守設計

### 監視・ログ設計

#### ログ分類
| ログ種別 | ファイル | 保存期間 | ローテーション |
|---|---|---|---|
| アプリケーション | app.log | 30日 | 日次 |
| API アクセス | api.log | 7日 | 日次 |
| システム | system.log | 30日 | 週次 |
| エラー | error.log | 90日 | 週次 |

#### ログ形式
```python
import logging
from datetime import datetime

# 統一ログ形式
LOG_FORMAT = "%(asctime)s [%(levelname)s] %(name)s: %(message)s"

# 構造化ログ（JSON）
{
    "timestamp": "2025-09-09T12:00:00Z",
    "level": "INFO",
    "component": "video_manager",
    "action": "video_generated",
    "data": {
        "video_id": 123,
        "prompt": "morning landscape",
        "generation_time": 180.5,
        "api_cost": 0.75
    }
}
```

### 自動監視システム
```python
class SystemMonitor:
    def __init__(self):
        self.checks = [
            self.check_disk_space,
            self.check_memory_usage,
            self.check_api_connectivity,
            self.check_video_playback,
            self.check_m5stack_connection
        ]
    
    async def run_health_checks(self) -> dict:
        results = {}
        for check in self.checks:
            try:
                results[check.__name__] = await check()
            except Exception as e:
                results[check.__name__] = {"status": "error", "error": str(e)}
        
        return results
    
    async def check_disk_space(self) -> dict:
        import shutil
        total, used, free = shutil.disk_usage("/")
        usage_percent = (used / total) * 100
        
        return {
            "status": "warning" if usage_percent > 80 else "ok",
            "usage_percent": usage_percent,
            "free_gb": free // (1024**3)
        }
```

### バックアップ戦略
```python
class BackupManager:
    def __init__(self):
        self.backup_targets = [
            "/home/pi/ai_painting_system/database/",
            "/home/pi/ai_painting_system/config/",
            "/home/pi/ai_painting_system/logs/"
        ]
    
    def create_backup(self, backup_type: str = "daily"):
        """
        バックアップ種別:
        - daily: 設定・DB・ログ
        - weekly: 上記 + 動画ファイル（選択）
        - manual: 全ファイル
        """
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = f"/home/pi/backups/{backup_type}_{timestamp}"
        
        # 実装詳細
        pass
```

### アップデート管理
```python
class UpdateManager:
    def check_updates(self) -> dict:
        """
        アップデート確認:
        - システムパッケージ
        - Python依存関係
        - アプリケーションコード
        """
        pass
    
    def apply_updates(self, update_type: str):
        """
        安全なアップデート適用:
        1. バックアップ作成
        2. アップデート適用
        3. 整合性確認
        4. ロールバック準備
        """
        pass
```

### 障害対応手順

#### 自動復旧シーケンス
1. **軽微な障害**: 自動再試行（3回まで）
2. **中程度の障害**: サービス再起動
3. **重大な障害**: フェールセーフモード移行

#### 手動対応手順書
```bash
# 緊急時対応コマンド集
# サービス状態確認
sudo systemctl status ai-painting

# ログ確認
tail -f /home/pi/ai_painting_system/logs/error.log

# 安全な再起動
sudo systemctl restart ai-painting

# 完全リセット（最終手段）
sudo systemctl stop ai-painting
sudo rm -rf /tmp/ai_painting_cache/*
sudo systemctl start ai-painting
```

### パフォーマンス最適化

#### システムリソース監視
```python
class PerformanceMonitor:
    def get_system_stats(self) -> dict:
        import psutil
        
        return {
            "cpu_percent": psutil.cpu_percent(interval=1),
            "memory_percent": psutil.virtual_memory().percent,
            "disk_io": psutil.disk_io_counters(),
            "network_io": psutil.net_io_counters(),
            "temperature": self.get_cpu_temperature()
        }
    
    def get_cpu_temperature(self) -> float:
        # Raspberry Pi CPU温度取得
        try:
            with open('/sys/class/thermal/thermal_zone0/temp', 'r') as f:
                temp = int(f.read()) / 1000.0
            return temp
        except:
            return 0.0
```

#### 最適化設定
```python
# Raspberry Pi 最適化設定
OPTIMIZATION_CONFIG = {
    # メモリ設定
    "gpu_mem": 128,  # GPU メモリ分割
    "swap_size": 2048,  # スワップサイズ (MB)
    
    # CPU設定
    "cpu_governor": "ondemand",  # CPU ガバナー
    "cpu_freq_max": 1800,  # 最大周波数 (MHz)
    
    # ファイルシステム最適化
    "mount_options": "noatime,nodiratime",
    
    # ネットワーク最適化
    "tcp_congestion": "bbr",
    "net_buffer_size": 65536
}
```

---

## 📈 パフォーマンス・スケーラビリティ

### 想定負荷・性能要件
| 項目 | 要件 | 目標値 |
|---|---|---|
| 動画切り替え応答時間 | 3秒以内 | 1秒以内 |
| Web UI応答時間 | 5秒以内 | 2秒以内 |
| システム稼働率 | 95%以上 | 99%以上 |
| メモリ使用率 | 80%以下 | 60%以下 |
| CPU使用率（平時） | 30%以下 | 20%以下 |

### スケーラビリティ設計
```python
# 将来的な拡張対応
class ScalabilityManager:
    def __init__(self):
        self.load_balancer = None  # 将来実装
        self.cache_cluster = None  # 分散キャッシュ
        
    def add_display_node(self, node_config: dict):
        """追加ディスプレイノード対応"""
        pass
    
    def setup_content_distribution(self):
        """コンテンツ配信最適化"""
        pass
```

---

## 🔄 エラーハンドリング・障害対応

### エラー分類・対応マトリックス
| エラー種別 | 重要度 | 自動対応 | 通知 | 手動対応 |
|---|---|---|---|---|
| VEO API エラー | 高 | フォールバック動画 | ✓ | API確認 |
| ネットワーク断 | 中 | キャッシュ動画 | ✓ | 接続確認 |
| 動画再生エラー | 中 | 次動画にスキップ | ✓ | ファイル確認 |
| M5STACK通信エラー | 低 | 再接続試行 | - | 物理確認 |
| ディスク容量不足 | 高 | 古いファイル削除 | ✓ | 容量確保 |

### エラーハンドリング実装
```python
class ErrorHandler:
    def __init__(self):
        self.retry_config = {
            "max_retries": 3,
            "backoff_factor": 2,
            "timeout": 30
        }
    
    async def handle_api_error(self, error: Exception, context: dict):
        if isinstance(error, APIQuotaExceeded):
            # クォータ超過時の対応
            await self.switch_to_cached_content()
            await self.schedule_retry_tomorrow()
            
        elif isinstance(error, NetworkError):
            # ネットワークエラー時の対応
            await self.retry_with_backoff()
            
        else:
            # その他のエラー
            await self.log_error_and_continue(error, context)
    
    async def failsafe_mode(self):
        """フェールセーフモード（最低限の機能で継続）"""
        # 基本的な静的画像表示に切り替え
        await self.display_controller.load_fallback_content()
        
        # システム状態をセーフモードに設定
        await self.system_status.set_mode("failsafe")
        
        # 定期的な復旧試行をスケジュール
        await self.schedule_recovery_attempts()
```

---
